<form id="login" onsubmit="event.preventDefault(); login()">
    <input type="text" name="username" placeholder="username" required><br>
    <input type="password" name="password" placeholder="password" required><br>
    <button type="submit">login</button>
</form>

<button id="logout" onclick="logout()">logout</button>

<h3>user</h3>
<pre id="user"></pre>

<h3>session</h3>
<pre id="session"></pre>


<script>
    let byId = (id) => document.getElementById(id)

    function set_user(user, session) {
        byId("user").innerHTML = JSON.stringify(user, null, 4)
        byId("session").innerHTML = JSON.stringify(session, null, 4)
        byId("login").style.display = user.id ? "none" : "block"
        byId("logout").style.display = !user.id ? "none" : "block"
    }

    async function load_user() {
        try {
            let r = await fetch("/api/me")
            if (!r.ok) { throw r }
            let { user, session } = await r.json()
            set_user(user, session)
        } catch (e) {
            alert(e.statusText || e.message)
        }
    }

    async function login() {
        let form = new FormData(byId("login"))
        try {
            let r = await fetch("/api/login", {
                method: "POST",
                body: JSON.stringify(Object.fromEntries(form)),
                headers: {
                    "Content-Type": "application/json"
                }
            })
            if (!r.ok) { throw r }
            await load_user()
        } catch (e) {
            if (e.status === 401) {
                let { detail } = await e.json()
                alert(detail)
            } else {
                alert(e.statusText || e.message)
            }
        }
    }

    async function logout() {
        try {
            let r = await fetch("/api/logout", {
                method: "POST",
                body: "",
            })
            if (!r.ok) { throw r }
            await load_user()
        } catch (e) {
            alert(e.statusText || e.message)
        }
    }

    load_user()
</script>
